#!/usr/bin/env python 

import roslib; roslib.load_manifest('myservice')
import rospy

# from myservice.srv import WordCount
from myservice.srv import trans_count
import sys

import numpy as np

import rospy
import cv2

from std_msgs.msg import String
from sensor_msgs.msg import Image
from cv_bridge import CvBridge, CvBridgeError

from scipy.misc import imresize, imsave, imshow
import time
import os
cwd = os.getcwd()


class ImageConverter:
    def __init__(self):
        self.imagetopic = "/kinect2/sd/image_ir"
        self.depthtopic = "/camera/depth/image_raw"
        self.pointstopic = "/camera/depth_registered/points"
        self.bridge = CvBridge()
        self.depth_color = None
        self.image_color_sub = None
        self.image_color_sub = rospy.Subscriber(self.imagetopic, Image, self.image_callback, self.image_color_sub)
        # self.image_depth_sub = rospy.Subscriber(self.depthtopic, Image, self.depth_callback)
        # self.points_cloud_sub = rospy.Subscriber(self.pointstopic, Image, self.points_callback)
        self.count = 0
        # count = 0

    def image_callback(self, data):

        try:
            data.encoding = "mono16"
            # cvImage = bridge.imgmsg_to_cv2(data, "mono8")
            self.img_color = self.bridge.imgmsg_to_cv2(data, "mono8")
            # print image_color.shape
            # print count
            # count_lock.acquire()
            # count += 1
            # print count
            t1 = time.time()
            cv2.imshow("Image window", self.img_color)
            k = cv2.waitKey(10)
            if k!=-1:
				print '====================>', k
            if k == 1048608:
                img_name = "Images/img_raw%02d.png" % self.count
                cv2.imwrite(img_name, self.img_color)
                # cv2.imwrite("raw_data03/depth/depth_raw00" + str(num) + ".png", depth_inf)
                # imsave(""+str(num)+".png", img_color)
                self.send_for_srv()
                self.count += 1

            print "prediction duration: ", time.time()-t1
        except CvBridgeError as e:
            print(e)
            cv2.destroyWindow("Image window")

    def depth_callback(self, data):
        global depth_inf
        try:
            self.depth_color = self.bridge.imgmsg_to_cv2(data, "16UC1")
            depth_inf[:, :, :] = self.depth_color
            # print depth_color.shape
            # cv2.imshow("Depth window", depth_color)
            k = cv2.waitKey(10)
            # count += 1
            # print "fuck:", k

        except CvBridgeError as e:
            print(e)
            cv2.destroyWindow("Depth window")

    def points_callback(self, data):
        global depth_inf
        try:
            self.points_cloud = self.bridge.imgmsg_to_cv2(data, "16UC1")
            # depth_inf[:, :, :] = self.depth_color
            print depth_color.shape
            # cv2.imshow("Depth window", depth_color)
            k = cv2.waitKey(10)
            # count += 1
            # print "fuck:", k

        except CvBridgeError as e:
            print(e)
            cv2.destroyWindow("Depth window")

    def send_for_srv(self):
        global cwd
        try:
            num_sender = rospy.ServiceProxy('robot_calibration', trans_count)

            # words = ''.join(sys.argv[1:])
            # print words
            send_return = num_sender(cwd, self.count)
            # word_count = word_counter(words)
            print '---------->', send_return.count, send_return.b
        except rospy.ServiceException, e:
            print "Service call failed: %s" % e


if __name__ == "__main__":
    print("reciving......")
    rospy.init_node('saveImg_client', anonymous=True)
    ic = ImageConverter()
    rate = rospy.Rate(1)  # 10hz

    rospy.wait_for_service('robot_calibration')

    try:
        rospy.spin()

    except KeyboardInterrupt:
        print("Shutting down")
    cv2.destroyAllWindows()

"""
if __name__ == '__main__':
    rospy.init_node('service_client')
    rospy.wait_for_service('word_count')
    try:
        num_sender = rospy.ServiceProxy('word_count', trans_count)
        # words = [str(ch) for ch in sys.argv[1:]]
        words = ''.join(sys.argv[1:])
        print words
        num = 2
        send_return = num_sender(words, num)
        # word_count = word_counter(words)
        print words, '->', send_return.count,send_return.b
    except rospy.ServiceException, e:
        print "Service call failed: %s" % e
"""
